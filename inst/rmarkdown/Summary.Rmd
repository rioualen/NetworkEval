---
title: "Network evaluation summary"
output:
 html_document:
   code_folding: hide
   fig_caption: yes
   highlight: zenburn
   self_contained: yes
   theme: cerulean
   toc: yes
   toc_depth: 2
   toc_float: yes
   number_sections: true
 word_document: default
 pdf_document:
   fig_caption: yes
   highlight: zenburn
   toc: yes
   toc_depth: 3
date: '`r Sys.Date()`'
author: 'Claire Rioualen'
params:
  predictions_dir: !r predictions_dir
  results_dir: !r results_dir
  # id: !r pos_set_id
  # discarded: !r discarded_tfs
---

<style type="text/css">

body{ /* Normal  */
      font-size: 14px;
  }
</style>

```{r setup, eval=TRUE, echo=FALSE, results='hide', include=FALSE, warnings=FALSE}
Sys.getenv("PATH")
# knitr::opts_knit$set(root.dir = "/Users/rioualen/Desktop/Git/NetworkEval")
knitr::opts_chunk$set(echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, results = 'asis', fig.width = 10, fig.height = 6)


library(DT)
library(dplyr)
# library(EcoliGenes)
library(eulerr)
library(ggplot2)
library(htmltools)
library(kableExtra)
library(UpSetR)
# library(tools) ## get file name without ext
```

This report is generated by the `NetworkEval` R package. Its purpose is to evaluate the accuracy of predicted TF-gene interactions, by comparing them against a set of positive and negative regulatory interactions (RIs) generated using various strategies. 

```{r run-eval, eval=F}

## to be removed
pred_files <- list.files(params$predictions_dir, full.names = T)
set_ids <- c()
for(f in pred_files){
  set <- basename(tools::file_path_sans_ext(f))
  # print(set)
  set_ids <- c(set_ids, set)
  if(!dir.exists(paste0(params$results_dir, "/", set))) {
    NetworkEval::run_eval(f)
  }
}
```

# Summary

## Summary table

```{r get-summary, eval=TRUE}
# ## to remove:first part
# 
# Set_ID <- c()
# RIs_input <- c()
# TFs_input <- c()
# RIs_TFfiltered <- c()
# TFs_filtered <- c()
# RIs_RIfiltered <- c()
# # AUC <- c()
# Sensitivity <- c()
# Specificity <- c()
# Precision <- c()
# TP <- c()
# FP <- c()
# 
# # set_ids <- list.files("results")
# for(set in set_ids) {
#   confusion <- read.delim(file = paste0(params$results_dir, "/", set, "/", set, "_confusion_matrix.tsv"), header=T, stringsAsFactors=FALSE)
#   in_ris <- read.delim(file = paste0(params$results_dir, "/", set, "/", set, "_in_stats.tsv"), header=T, stringsAsFactors=FALSE)
#   out_ris <- read.delim(file = paste0(params$results_dir, "/", set, "/", set, "_out_stats.tsv"), header=T, stringsAsFactors=FALSE)
#   stats <- read.delim(file = paste0(params$results_dir, "/", set, "/", set, "_statistics.tsv"), header=T, stringsAsFactors=FALSE)
# 
#   Set_ID <- c(Set_ID, set)
#   RIs_input <- c(RIs_input, in_ris$RIs)
#   TFs_input <- c(TFs_input, in_ris$TFs)
#   RIs_TFfiltered <- c(RIs_TFfiltered, out_ris$RIs)
#   TFs_filtered <- c(TFs_filtered, out_ris$TFs)
#   RIs_RIfiltered <- c(RIs_RIfiltered, confusion$total_population[1])
#   # AUC <- c()
#   Sensitivity <- c(Sensitivity, stats$sensitivity)
#   Specificity <- c(Specificity, stats$specificity)
#   Precision <- c(Precision, stats$precision)
#   TP <- c(TP, confusion$control_positive[1])
#   FP <- c(FP, confusion$control_negative[1])
# }
# 
# summary_df <- data.frame(Set_ID , RIs_input, TFs_input, RIs_TFfiltered, TFs_filtered, RIs_RIfiltered, Sensitivity, Specificity, Precision, TP, FP, stringsAsFactors=F)
# #summary_df <- summary_df %>% dplyr::mutate(group=ifelse(grepl("expression", Set_ID), "expression", ifelse(grepl("physical", Set_ID), "physical", "control")))
# 
# # kable(summary_df, digits=3, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 12, bootstrap_options = c("striped", "hover"))

summary_df <- read.delim(paste0(params$results_dir, "/summary_report/summary_table.tsv"))

datatable(summary_df, rownames= FALSE, options = list(searching = FALSE, pageLength = 25)) %>% 
  formatCurrency(c("RIs_input", "RIs_TFfiltered", "RIs_RIfiltered", "TP", "FP"), currency='') %>%
  formatRound(c("RIs_input", "RIs_TFfiltered", "RIs_RIfiltered", "TP", "FP"), digits=0) %>%
  formatRound(c("Sensitivity", "Specificity", "Precision"), digits=3) %>%
  formatStyle('Sensitivity',  background = styleColorBar(range(summary_df$Sensitivity), 'burlywood')) %>%
  formatStyle('Specificity',  background = styleColorBar(range(summary_df$Specificity), 'burlywood')) %>%
  formatStyle('Precision',  background = styleColorBar(range(summary_df$Precision), 'burlywood')) #%>% 
  #formatStyle(  'Set_ID', 'group',  backgroundColor = styleEqual(c("control", "expression", "physical"), c('lightcoral', 'lightgreen', "lightblue")))


```

## Histograms

```{r histograms, eval=TRUE}

# long <- tidyr::gather(summary_df, "variable", "value", c("Sensitivity", "Specificity", "Precision"))
# long <- long %>% dplyr::mutate(group=ifelse(grepl("expression", Set_ID), "expression", ifelse(grepl("physical", Set_ID), "physical", "control")))
# long$variable <- factor(long$variable, levels = c("Sensitivity", "Specificity", "Precision"))
# 
# 
# ggplot(long, aes(x = Set_ID, y = value)) + 
#   geom_bar(stat = "identity") + 
#   geom_col(aes(fill = group)) +
#   scale_y_continuous(breaks = seq(0, 1, by = 0.1)) +
#   # scale_color_brewer(palette="Dark2") +
#   # scale_color_manual(values=c("#000000", "#E69F00", "#56B4E9")) +
#   # scale_x_discrete(limits = rev(levels(cpxr.data$Method))) +
#   scale_fill_manual(values = c( "#60AE20", "#00AFBB"), guide=guide_legend(reverse=T)) +
#   theme(axis.text.y = element_text(size=10), axis.title.x = element_blank(), legend.title = element_blank(), strip.text.x = element_text(size = 14), strip.text.y = element_text(size = 14), axis.title.y = element_blank(), legend.position="none", legend.text = element_text(size = 11), legend.direction="vertical", axis.text.x = element_text(angle = 90, hjust=1, size=12)) +
#   facet_grid(variable ~ .)

cat(paste0("![](", results_dir, "/summary_report/histogram.png)"), "\n")

```

## Venn

```{r venn, eval=TRUE, fig.width=8, fig.height=4}

# positive_set <- read.delim(file = system.file("control_sets", "all_positive.tsv", package = "NetworkEval"), header=T, stringsAsFactors=FALSE)
# positive_set <- positive_set %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum))
# positive_set <- positive_set %>% dplyr::arrange(tf_bnum, gene_bnum)
# positive_set <- positive_set %>% dplyr::distinct(pair, .keep_all = TRUE)
# 
# negative_set <- read.delim(file = system.file("control_sets", "all_negative.tsv", package = "NetworkEval"), header=T, stringsAsFactors=FALSE)
# negative_set <- negative_set %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum))
# negative_set <- negative_set %>% dplyr::arrange(tf_bnum, gene_bnum)
# negative_set <- negative_set %>% dplyr::distinct(pair, .keep_all = TRUE)
# 
# prediction_set <- data.frame(matrix(ncol=2), stringsAsFactors = F)
# colnames(prediction_set) <- c("tf_bnum", "gene_bnum")
# for(s in set_ids) {
#   ris <- read.delim(file = paste0(predictions_dir, "/", s, ".tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
#   prediction_set <- rbind.data.frame(prediction_set, ris)
# }
# prediction_set <- prediction_set %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum))
# prediction_set <- prediction_set %>% dplyr::arrange(tf_bnum, gene_bnum)
# prediction_set <- prediction_set %>% dplyr::distinct(pair, .keep_all = TRUE)
# 
# 
# data <- list(Predictions=prediction_set$pair, Positive=positive_set$pair)
# plot(euler(data, shape = "ellipse"), fills =  c("lightblue", "lightcoral"), quantities=T)
# 
# data_bis <- list(Predictions=prediction_set$pair, Positive=positive_set$pair, Negative=negative_set$pair)
# plot(euler(data_bis, shape = "circle"), fills =  c("lightblue", "lightcoral", "white"))

# cat(paste0("![](", results_dir, "/summary_report/venn1.png)"), "\n")
# cat(paste0("![](", results_dir, "/summary_report/venn2.png)"), "\n")


```

## Upset 

```{r show-upset, eval=TRUE, fig.width=8, fig.height=4}

cat(paste0("![](", results_dir, "/summary_report/upset.png)"), "\n")

# data_all <- list()
# all_sets <- data.frame(matrix(ncol=3), stringsAsFactors = F)
# colnames(all_sets) <- c("tf_bnum", "gene_bnum", "pair")
# for(s in set_ids) {
#    ris <- read.delim(file = paste0(predictions_dir, "/", s, ".tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
#    ris <- ris %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum))
#    data_all[[s]] <- ris$pair
#    all_sets <- rbind.data.frame(all_sets, ris)
# }
# 
# if (length(set_ids) > 1) {
  # upset(fromList(data_bis), nsets = length(data_bis), number.angles = 30, point.size = 3, line.size = 2, 
  #     mainbar.y.label = "Sets Intersections", sets.x.label = "Set IDs", 
  #     text.scale = c(2, 2, 2, 1, 1.5, 1.2), order.by='freq')#, 
#       #sets.bar.color=c("lightgreen", "lightgreen", "lightblue", "lightgreen", "lightgreen", "lightgreen", "lightblue",  "lightgreen", "lightcoral", "lightblue"))
# } else {
#   cat("\n\n This requires a minimum of 2 prediction sets.\n\n")
# }
```

<!-- ## Venn by categories -->

```{r venn-tags, eval=FALSE}
expression_set <- data.frame(matrix(ncol=2), stringsAsFactors = F)
colnames(expression_set) <- c("tf_bnum", "gene_bnum")
for(s in set_ids) {
  if(grepl("expression", s)) {
    ris <- read.delim(file = paste0(predictions_dir, "/", s, ".tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
    expression_set <- rbind.data.frame(expression_set, ris)
  }
}
expression_set <- expression_set %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum))
expression_set <- expression_set %>% dplyr::arrange(tf_bnum, gene_bnum)
expression_set <- expression_set %>% dplyr::distinct(pair, .keep_all = TRUE)

physical_set <- data.frame(matrix(ncol=2), stringsAsFactors = F)
colnames(physical_set) <- c("tf_bnum", "gene_bnum")
for(s in set_ids) {
  if(grepl("physical", s)) {
    ris <- read.delim(file = paste0(predictions_dir, "/", s, ".tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
    physical_set <- rbind.data.frame(physical_set, ris)
  }
}
physical_set <- physical_set %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum))
physical_set <- physical_set %>% dplyr::arrange(tf_bnum, gene_bnum)
physical_set <- physical_set %>% dplyr::distinct(pair, .keep_all = TRUE)
```

<!-- ## Venn physical -->

```{r venn-physical, eval=FALSE}
## venn physical indu vs native

physical_set_inducible <- read.delim(file = paste0(predictions_dir, "/physical_potential_interactions_update_inducible_131.tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
physical_set_inducible <- physical_set_inducible %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum)) %>% dplyr::arrange(tf_bnum, gene_bnum) %>% dplyr::distinct(pair, .keep_all = TRUE)

physical_set_native <- read.delim(file = paste0("../NetworkData/predictions/physical_potential_interactions_update_native_131.tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
physical_set_native <- physical_set_native %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum)) %>% dplyr::arrange(tf_bnum, gene_bnum) %>% dplyr::distinct(pair, .keep_all = TRUE)

data <- list(Physical=physical_set$pair, Inducible=physical_set_inducible$pair, Native=physical_set_native$pair, Positive=positive_set$pair)
#plot(venn(data), fills =  c("lightblue", "lightblue", "lightblue", "lightcoral"), quantities=T)
plot(euler(data, shape = "ellipse"), fills =  c("lightblue", "lightblue", "lightblue", "lightcoral"), quantities=T)

``` 

<!-- ## Venn expression -->

```{r venn-expression, eval=FALSE}
## veenn expression indu vs ko

expression_set_inducible <- read.delim(file = paste0("../NetworkData/predictions/expression_aracne_update_inducible_74.tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
expression_set_inducible <- expression_set_inducible %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum)) %>% dplyr::arrange(tf_bnum, gene_bnum) %>% dplyr::distinct(pair, .keep_all = TRUE)

expression_set_knockout <- read.delim(file = paste0("../NetworkData/predictions/expression_aracne_update_knockout_74.tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
expression_set_knockout <- expression_set_knockout %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum)) %>% dplyr::arrange(tf_bnum, gene_bnum) %>% dplyr::distinct(pair, .keep_all = TRUE)

data <- list(Expression=expression_set$pair, Inducible=expression_set_inducible$pair, Knockout=expression_set_knockout$pair, Positive=positive_set$pair)
plot(venn(data), fills =  c("lightgreen", "lightgreen", "lightgreen", "lightcoral"), quantities=T)
plot(euler(data, shape = "ellipse"), fills =  c("lightgreen", "lightgreen", "lightgreen", "lightcoral"), quantities=T)

expression_set_inducible_bis <- read.delim(file = paste0("../NetworkData/predictions/expression_aracne_update_inducible_74_bis.tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
expression_set_inducible_bis <- expression_set_inducible_bis %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum)) %>% dplyr::arrange(tf_bnum, gene_bnum) %>% dplyr::distinct(pair, .keep_all = TRUE)

expression_set_knockout_bis <- read.delim(file = paste0("../NetworkData/predictions/expression_aracne_update_knockout_74_bis.tsv"), header=T, stringsAsFactors=FALSE)[c("tf_bnum", "gene_bnum")]
expression_set_knockout_bis <- expression_set_knockout_bis %>% dplyr::mutate(pair= paste0(tf_bnum, "_", gene_bnum)) %>% dplyr::arrange(tf_bnum, gene_bnum) %>% dplyr::distinct(pair, .keep_all = TRUE)

data <- list(Expression=expression_set$pair, Inducible=expression_set_inducible_bis$pair, Knockout=expression_set_knockout_bis$pair, Positive=positive_set$pair)
plot(venn(data), fills =  c("lightgreen", "lightgreen", "lightgreen", "lightcoral"), quantities=T)
plot(euler(data, shape = "ellipse"), fills =  c("lightgreen", "lightgreen", "lightgreen", "lightcoral"), quantities=T)
```

<!-- ## Upset by categories -->

```{r uspet-tags, eval=FALSE}

upset(fromList(data_bis), nsets = 4, number.angles = 30, point.size = 3.5, line.size = 2, 
    mainbar.y.label = "Sets Intersections", sets.x.label = "Set IDs", 
    text.scale = c(1.3, 1.3, 1, 1, 2, 1.5), order.by='freq', color.pal = c("red"),
    sets.bar.color=c("lightgrey", "lightgreen", "lightblue", "lightcoral"))
```
    

# Datasets

```{r case-by-case, eval=TRUE}

for(s in set_ids) {
   if(s == "control_regulondb_network_tf_gene") {
     # cat(paste0("\n## ", s))
     # cat(paste0("\n### Stats\n"))
     # 
     # # datatable(summary_df %>% filter(Set_ID==s), rownames= FALSE, 
     # #           options = list(searching = FALSE, pageLength = 10, lengthChange = FALSE, paging=FALSE)) %>%
     # #  formatCurrency(c("RIs_input", "RIs_TFfiltered", "RIs_RIfiltered", "TP", "FP"), currency='') %>%
     # #  formatRound(c("RIs_input", "RIs_TFfiltered", "RIs_RIfiltered", "TP", "FP"), digits=0) %>%
     # #  formatRound(c("Sensitivity", "Specificity", "Precision"), digits=3)
     # cat(kable(summary_df %>% filter(Set_ID==s), digits=3, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 12, bootstrap_options = c("striped", "hover")))
     # 
     # confusion <- read.delim(file = paste0("results/", s, "/", s, "_confusion_matrix.tsv"), header=T, stringsAsFactors=FALSE)
     # rownames(confusion) <- c("predicted_positive", "predicted_negative", "total")
     # cat(kable(confusion, digits=3, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 12, bootstrap_options = c("striped", "hover")))
   } else {

     cat(paste0("\n## ", s, " {.tabset}"))
     cat(paste0("\n **Stats**\n"))
     
     # Somehow datatables don't work properly inside loops / with html rendering
     # dt <- datatable(summary_df %>% filter(Set_ID==s), rownames= FALSE, 
      #          options = list(searching = FALSE, pageLength = 10, lengthChange = FALSE, paging=FALSE)) %>%
      # formatCurrency(c("RIs_input", "RIs_TFfiltered", "RIs_RIfiltered", "TP", "FP"), currency='') %>%
      # formatRound(c("RIs_input", "RIs_TFfiltered", "RIs_RIfiltered", "TP", "FP"), digits=0) %>%
      # formatRound(c("Sensitivity", "Specificity", "Precision"), digits=3)
     # print( htmltools::tagList(dt) )
     cat(kable(summary_df %>% filter(Set_ID==s), digits=3, format.args = list(big.mark = ',')) %>% kable_styling(full_width = T, font_size = 12, bootstrap_options = c("striped", "hover")))
  
     confusion <- read.delim(file = paste0(results_dir, "/", s, "/", s, "_confusion_matrix.tsv"), header=T, stringsAsFactors=FALSE)
     rownames(confusion) <- c("predicted_positive", "predicted_negative", "total")
     cat(kable(confusion, digits=3, format.args = list(big.mark = ',')) %>% kable_styling(full_width = T, font_size = 12, bootstrap_options = c("striped", "hover")))
  
     cat(paste0("\n### ROC curve\n"))
     
     # knitr::include_graphics(paste0("results/", set, "/", set, "_roc.pdf"))
     cat(paste0("![](", results_dir, "/", s, "/", s, "_roc.png)"), "\n")
     
     cat(paste0("\n### Precision-recall curve\n"))
     
     # knitr::include_graphics(paste0("results/", set, "/", set, "_roc.pdf"))
     cat(paste0("![](", results_dir, "/", s, "/", s, "_prc.png)"), "\n")
   }
}
```
