---
title: "Network evaluation report"
output:
 html_document:
   code_folding: hide
   fig_caption: yes
   highlight: zenburn
   self_contained: yes
   theme: cerulean
   toc: yes
   toc_depth: 2
   toc_float: yes
   number_sections: true
 word_document: default
 pdf_document:
   fig_caption: yes
   highlight: zenburn
   toc: yes
   toc_depth: 3
date: '`r Sys.Date()`'
author: 'Claire Rioualen'
params:
  evalset: !r my_eval
  predictions: !r predicted_set
  id: !r pos_set_id
  # discarded: !r discarded_tfs
---


<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
</style>


```{r setup, eval=TRUE, echo=FALSE, results='hide', include=FALSE, warnings=FALSE}
Sys.getenv("PATH")
knitr::opts_knit$set(root.dir = "/Users/rioualen/Desktop/NetworkEval/")
knitr::opts_chunk$set(echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, results = 'asis')

library(kableExtra)
```

This report is generated by the `NetworkEval` R package. Its purpose is to evaluate the accuracy of a set of predicted TF-gene interactions, by comparing them against a set of positive and negative regulatory interactions (RIs) generated using various strategies. 

```{r gene-ids}
master_genes <- read.delim("regulondb/GeneProduct-IDs.tsv", comment.char = "#", header = F, stringsAsFactors = F)
colnames(master_genes) <- c("REGULONDB_ID", "ECOCYC_ID", "BNUMBER", "GENE_NAME", "GENE_SYNONYMS", "GENE_POSLEFT", "GENE_POSRIGHT", "GENE_STRAND", "GENE_TYPE",
"PRODUCT_ID", "PRODUCT_NAME", "PRODUCT_SYNONYMS", "PRODUCT_TYPE")

## non-unique bnumbers
# master_genes$BNUMBER[duplicated(master_genes$BNUMBER)][grep("b", master_genes$BNUMBER[duplicated(master_genes$BNUMBER)])]

gene_list_by_bnum <- split(master_genes, master_genes$BNUMBER)
gene_list_by_symbol <- split(master_genes, master_genes$GENE_NAME)

gene_list_by_synonyms <- master_genes %>% tidyr::separate_rows(GENE_SYNONYMS, sep = ",")
gene_list_by_synonyms <- split(gene_list_by_synonyms, gene_list_by_synonyms$GENE_SYNONYMS)

gene_list_by_any_name <- c(gene_list_by_symbol, gene_list_by_synonyms)

```

# Prediction set: `r pred_set_id`

## Summary of input interactions

```{r pred-set-1}
# cat(paste0("Evaluated set: ", pred_set_id))

kable(summarize(predicted_set), digits=2, format.args = list(big.mark = ','))  %>% kable_styling(full_width = F, font_size = 20)

# cat("<b>List of TFs: </b>")
# cat(paste0((get_tfs(my_eval@pred_set)), collapse = ", "))
```

## Selection of transcription factors

**Evaluated TFs**

In order to evaluate TF-gene predicted interactions, we first select the TFs for which we have controls available. The following TFs will thus be evaluated:

```{r pred-set-2}
tfs_in <- sapply(get_tfs_eval(my_eval), FUN=function(x){gene_list_by_bnum[[x]]$GENE_NAME[1]})
cat(paste0((sort(tfs_in)), collapse = ", "))

cat(paste0("\n\n* Total: ", length(tfs_in)))

```

**Discarded TFs**

The following TFs were discarded, for there is no control available to evaluate their interactions:

```{r pred-set-3}

tfs_out <- setdiff(get_tfs(predicted_set), get_tfs(filtered_predicted_set))
tfs_out <- sapply(tfs_out, FUN=function(x){gene_list_by_bnum[[x]]$GENE_NAME[1]})

cat(paste0((sort(tfs_out)), collapse = ", "))

cat(paste0("\n\n* Total: ", length(tfs_out)))

```

The interactions involving those TFs are also discarded of the evaluation.

* Number of interactions excluded: `r get_ris_n(predicted_set)-get_ris_n(my_eval@pred_set)`

# Evaluation

## Summary of evaluated interactions

```{r eval-set-1}

kable(summarize(my_eval@pred_set), digits=2, format.args = list(big.mark = ','))  %>% kable_styling(full_width = F, font_size = 20)

# cat("<b>List of TFs: </b>")
# cat(paste0((get_tfs(my_eval@pred_set)), collapse = ", "))
```

## Statistics 

```{r evalset-2}
kable(summarize_stats(my_eval), digits=3, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 20)
```

## Confusion matrix

```{r evalset-3}
kable(generate_confusion_matrix(my_eval), digits=2, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 20)
```

Only interactions that present in either the positive set or the negative set can be labeled. The other interactions are not displayed

* Number of interactions not displayed: `r get_ris_n(outer_set(my_eval))`

* Proportion of the evaluated set: `r round(get_ris_n(outer_set(my_eval))/get_ris_n(my_eval@pred_set)*100, 1)`%

## Venn diagrams

### Comparison of sets

```{r evalset-4}
generate_venn_diagram(my_eval, style=1, universe=FALSE)
generate_venn_diagram(my_eval, style=2, universe=FALSE)
```

### Comparison of sets -- including all possible interactions

```{r evalset-5}
generate_venn_diagram(my_eval, style=1, universe=TRUE)
generate_venn_diagram(my_eval, style=2, universe=TRUE)
```

## Curves

### ROC curve

NB: curve based on `r round(get_ris_n(inner_set(my_eval))/get_ris_n(my_eval@pred_set)*100, 1)`% of the data.

```{r evalset-6}
# for (s in names(my_eval@pred_set@scores)) {
#    cat(paste0("\n\n#### ", s, " \n\n"))
   # generate_roc_curve(my_eval, s)
# }
generate_roc_curve(my_eval)
```

### Precision-Recall curve

NB: curve based on `r round(get_ris_n(inner_set(my_eval))/get_ris_n(my_eval@pred_set)*100, 1)`% of the data.

```{r evalset-7}
# generate_pr_curve(my_eval)
```

# Control sets

## Summary of the positive set

```{r control-sets-1}
kable(summarize(my_eval@pos_set), digits=2, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 20)

# cat("<b>List of TFs: </b>")
# cat(paste0((get_tfs(my_eval@pos_set)), collapse = ", "))
```

## Summary of the negative set

```{r control-sets-2}
kable(summarize(my_eval@neg_set), digits=2, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 20)

# cat("<b>List of TFs: </b>")
# cat(paste0((get_tfs(my_eval@neg_set)), collapse = ", "))
```
