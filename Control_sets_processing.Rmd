---
title: "Control sets processing report"
output:
 html_document:
   code_folding: hide
   fig_caption: yes
   highlight: zenburn
   self_contained: yes
   theme: cerulean
   toc: yes
   toc_depth: 2
   toc_float: yes
   number_sections: true
 word_document: default
 pdf_document:
   fig_caption: yes
   highlight: zenburn
   toc: yes
   toc_depth: 3
date: '`r Sys.Date()`'
author: 'Claire Rioualen'
---

<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
</style>

```{r setup, eval=TRUE, echo=FALSE, results='hide', include=FALSE, warnings=FALSE}
Sys.getenv("PATH")
knitr::opts_knit$set(root.dir = "/Users/rioualen/Desktop/NetworkEval/")
knitr::opts_chunk$set(echo=FALSE, include=TRUE, warning=FALSE, message=FALSE, results = 'asis')

library(kableExtra)
library(DT)
library(dplyr)
library(UpSetR)
```


```{r gene-ids}
master_genes <- read.delim("regulondb/GeneProduct-IDs.tsv", comment.char = "#", header = F, stringsAsFactors = F)
colnames(master_genes) <- c("REGULONDB_ID", "ECOCYC_ID", "BNUMBER", "GENE_NAME", "GENE_SYNONYMS", "GENE_POSLEFT", "GENE_POSRIGHT", "GENE_STRAND", "GENE_TYPE",
"PRODUCT_ID", "PRODUCT_NAME", "PRODUCT_SYNONYMS", "PRODUCT_TYPE")

## non-unique bnumbers
# master_genes$BNUMBER[duplicated(master_genes$BNUMBER)][grep("b", master_genes$BNUMBER[duplicated(master_genes$BNUMBER)])]

gene_list_by_bnum <- split(master_genes, master_genes$BNUMBER)
gene_list_by_symbol <- split(master_genes, master_genes$GENE_NAME)

gene_list_by_synonyms <- master_genes %>% tidyr::separate_rows(GENE_SYNONYMS, sep = ",")
gene_list_by_synonyms <- split(gene_list_by_synonyms, gene_list_by_synonyms$GENE_SYNONYMS)

gene_list_by_any_name <- c(gene_list_by_symbol, gene_list_by_synonyms)

```

```{r data-dani, eval=F}
#### TF-TU
red_fisica_tf_tu <- read.delim("predictions/interactionScores_pnTF-TU_v1.tsv", comment.char = "#", header = T, stringsAsFactors = F)

red_fisica_tf_tu_revised <- data.frame(matrix(ncol=4))
colnames(red_fisica_tf_tu_revised) <- c("tf_symbol", "gene_symbol", "tf_bnum", "gene_bnum")
for (i in 1:nrow(red_fisica_tf_tu)) {
	tf_symbol <- red_fisica_tf_tu$symbol[i]
	gene_symbol <- red_fisica_tf_tu$tu_genes[i]
	red_fisica_tf_tu_revised <- rbind.data.frame(red_fisica_tf_tu_revised, 
																							 c(tf_symbol, gene_symbol, 
																							 	ifelse(!is.null(gene_list_by_symbol[[tf_symbol]]$BNUMBER[1]), gene_list_by_symbol[[tf_symbol]]$BNUMBER[1], ifelse(!is.null(gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1]), gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1], FALSE)), 
																							 	ifelse(!is.null(gene_list_by_symbol[[gene_symbol]]$BNUMBER[1]), gene_list_by_symbol[[gene_symbol]]$BNUMBER[1], ifelse(!is.null(gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1]), gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1], FALSE))))
}
red_fisica_tf_tu_revised <- red_fisica_tf_tu_revised[-1,]

red_fisica_tf_tu_revised_false <- red_fisica_tf_tu_revised %>% dplyr::filter_at(dplyr::vars(tf_bnum, gene_bnum), dplyr::any_vars(. %in% c(FALSE, "-")))
write.table(red_fisica_tf_tu_revised_false, file="predictions/interactionScores_pnTF-TU_v1_revised.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

false_gene_list <- unique(red_fisica_tf_tu_revised_false$gene_symbol)	
red_fisica_tf_tu_revised_true <- red_fisica_tf_tu %>% dplyr::filter(! (tu_genes %in% false_gene_list))

tf_bnum <- sapply(red_fisica_tf_tu_revised_true$symbol, FUN=function(x){gene_list_by_any_name[[x]]$BNUMBER[1]})
gene_bnum <- sapply(red_fisica_tf_tu_revised_true$tu_genes, FUN=function(x){gene_list_by_any_name[[x]]$BNUMBER[1]})
red_fisica_tf_tu_revised_true <- cbind.data.frame(red_fisica_tf_tu_revised_true, tf_bnum, gene_bnum)

write.table(red_fisica_tf_tu_revised_true, file="predictions/physical_network_tf_tu.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

#### TF-gene
red_fisica_tf_gene <- read.delim("predictions/interactionScores_pnTF-gene_v1.tsv", comment.char = "#", header = T, stringsAsFactors = F)

red_fisica_tf_gene_revised <- data.frame(matrix(ncol=4))
colnames(red_fisica_tf_gene_revised) <- c("tf_symbol", "gene_symbol", "tf_bnum", "gene_bnum")
for (i in 1:nrow(red_fisica_tf_gene)) {
	tf_symbol <- red_fisica_tf_gene$symbol[i]
	gene_symbol <- red_fisica_tf_gene$gene_name[i]
	red_fisica_tf_gene_revised <- rbind.data.frame(red_fisica_tf_gene_revised, 
																							 c(tf_symbol, gene_symbol, 
																							 	ifelse(!is.null(gene_list_by_symbol[[tf_symbol]]$BNUMBER[1]), gene_list_by_symbol[[tf_symbol]]$BNUMBER[1], ifelse(!is.null(gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1]), gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1], FALSE)), 
																							 	ifelse(!is.null(gene_list_by_symbol[[gene_symbol]]$BNUMBER[1]), gene_list_by_symbol[[gene_symbol]]$BNUMBER[1], ifelse(!is.null(gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1]), gene_list_by_synonyms[[tf_symbol]]$BNUMBER[1], FALSE))))
}
red_fisica_tf_gene_revised <- red_fisica_tf_gene_revised[-1,]

red_fisica_tf_gene_revised_false <- red_fisica_tf_gene_revised %>% dplyr::filter_at(dplyr::vars(tf_bnum, gene_bnum), dplyr::any_vars(. %in% c(FALSE, "-")))

write.table(red_fisica_tf_gene_revised_false, file="predictions/interactionScores_pnTF-gene_v1_revised.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

false_gene_list <- unique(red_fisica_tf_gene_revised_false$gene_symbol)	

red_fisica_tf_gene_revised_true <- red_fisica_tf_gene %>% 
	dplyr::filter(! (gene_name %in% false_gene_list))

tf_bnum <- sapply(red_fisica_tf_gene_revised_true$symbol, FUN=function(x){gene_list_by_any_name[[x]]$BNUMBER[1]})
gene_bnum <- sapply(red_fisica_tf_gene_revised_true$gene_name, FUN=function(x){gene_list_by_any_name[[x]]$BNUMBER[1]})
red_fisica_tf_gene_revised_true <- cbind.data.frame(red_fisica_tf_gene_revised_true, tf_bnum, gene_bnum)

write.table(red_fisica_tf_gene_revised_true, file="predictions/physical_network_tf_gene.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

# pb_list <- unique(red_fisica_tf_gene_revised_false$gene_symbol)
# pbc_gene_names <- master_genes %>% dplyr::filter(GENE_NAME %in% liste_pb)
# write.table(pbc_gene_names, file="pbc_genes_tf_genes.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

```


```{r control-sets-process-unique, eval=F}

# list_cset_id <- sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(list.files("control_sets")))
list_cset_id <- c("positive_1_1", "positive_2_1", "negative_2_1", "negative_2_2", "negative_1_1")
# list_cset_id <- c("positive_2_1", "negative_1_1")

all_ris_no_filter <- data.frame(matrix(ncol=4), stringsAsFactors = F)
colnames(all_ris_no_filter) <- c("tf_bnum", "gene_bnum", "cset_type", "cset_id")

################################################################
# New gene file with synonyms (Heli)
################################################################
for (cset in list_cset_id) {
	assign(cset, read.delim(paste0("control_sets/", cset, ".tsv"), stringsAsFactors = F))

	valid_tf <- c()
	valid_gene <- c()

	for (i in 1:nrow(get(cset))) {
		print(i)
		tf_bnum <- get(cset)[i, "tf_bnum"]
		gene_bnum <- get(cset)[i, "gene_bnum"]
		tf_symbol <- get(cset)[i, "tf_symbol"]
		gene_symbol <- get(cset)[i, "gene_symbol"]

		## test if input files are valid (correspondence between bnum and symbols)
		if ((!is.null(gene_list_by_bnum[[eval(tf_bnum)]]))
				&& (identical(tf_symbol, gene_list_by_bnum[[eval(tf_bnum)]]$GENE_NAME[1]) || (tf_symbol %in% strsplit(gene_list_by_bnum[[eval(tf_bnum)]]$GENE_SYNONYMS, split=",")[[1]]))) {
			test_tf <- TRUE
		} else {
			test_tf <- FALSE
		}
		if ((!is.null(gene_list_by_bnum[[eval(gene_bnum)]]))
				&& (identical(gene_symbol, gene_list_by_bnum[[eval(gene_bnum)]]$GENE_NAME[1]) || (gene_symbol %in% strsplit(gene_list_by_bnum[[eval(gene_bnum)]]$GENE_SYNONYMS, split=",")[[1]]))) {
			test_gene <- TRUE
		} else {
			test_gene <- FALSE
		}
		valid_tf <- c(valid_tf, test_tf)
		valid_gene <- c(valid_gene, test_gene)

		## build file with all ris and their cset id
		if ((test_tf==TRUE) && (test_gene==TRUE)) {
			# print(paste0(c(tf_bnum, gene_bnum, strsplit(cset, "_")[[1]][1], cset)))
			all_ris_no_filter <- rbind.data.frame(all_ris_no_filter, c(tf_bnum, gene_bnum, strsplit(cset, "_")[[1]][1], cset))
		}

	}
	assign(cset, cbind.data.frame(get(cset), valid_tf, valid_gene))
	revised_false_df <- get(cset) %>% dplyr::filter_at(dplyr::vars(valid_tf, valid_gene), dplyr::any_vars(. %in% c(FALSE)))
	write.table(revised_false_df, file=paste0("control_sets/", cset, "_revised.tsv"), row.names = F, quote = F, sep = "\t")
}
all_ris_no_filter <- all_ris_no_filter[-1,]

write.table(all_ris_no_filter, file="control_sets/processed/all_ris_not_filtered.tsv", col.names = T, row.names = F, quote = F, sep = "\t")

```

```{r categories}

all_ris_no_filter <- read.delim("control_sets/processed/all_ris_not_filtered.tsv", header=T)

ambivalent_ris <- all_ris_no_filter %>%
	arrange(tf_bnum, gene_bnum) %>%
	group_by(tf_bnum, gene_bnum) %>%
	mutate(cset_type = paste(collapse=",",unique(cset_type)), cset_id = paste(collapse=",",unique(cset_id)) ) %>%
	mutate(ntype=length(strsplit(cset_type, ",")[[1]])) %>%
	mutate(nid=length(strsplit(cset_id, ",")[[1]])) %>%
	filter(ntype==2) %>%
	unique() %>%
	mutate(tf_symbol=gene_list_by_bnum[[eval(tf_bnum)]]$GENE_NAME[1]) %>%
	mutate(gene_symbol=gene_list_by_bnum[[eval(gene_bnum)]]$GENE_NAME[1]) %>%
	select(tf_bnum, gene_bnum, tf_symbol, gene_symbol, cset_type, cset_id)

black_list <- paste0(ambivalent_ris$tf_bnum, "_", ambivalent_ris$gene_bnum)

all_negative_ris <- all_ris_no_filter %>%
	filter(cset_type=="negative") %>%
	arrange(tf_bnum, gene_bnum, cset_type) %>%
	group_by(tf_bnum, gene_bnum, cset_type) %>%
	summarise(cset_id=paste(collapse=",",unique(cset_id))) %>%
	mutate(n=length(strsplit(cset_id, ",")[[1]])) %>%
	mutate(black=paste0(tf_bnum, "_", gene_bnum)) %>%
	filter(!black %in% black_list ) %>%
	select(tf_bnum, gene_bnum, cset_type, cset_id, n)

all_positive_ris <- all_ris_no_filter %>%
	filter(cset_type=="positive") %>%
	arrange(tf_bnum, gene_bnum, cset_type) %>%
	group_by(tf_bnum, gene_bnum, cset_type) %>%
	summarise(cset_id=paste(collapse=",",unique(cset_id))) %>%
	mutate(n=length(strsplit(cset_id, ",")[[1]])) %>%
	mutate(black=paste0(tf_bnum, "_", gene_bnum)) %>%
	filter(!black %in% black_list ) %>%
	select(tf_bnum, gene_bnum, cset_type, cset_id, n)

write.table(all_negative_ris, file="control_sets/processed/all_negative.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
write.table(all_positive_ris, file="control_sets/processed/all_positive.tsv", col.names = T, row.names = F, quote = F, sep = "\t")
```

```{r control-sets}
summary <- read.delim("control_sets/summary.tsv", stringsAsFactors = F)

positive_controls_summary <- all_ris_no_filter %>%
	filter(cset_type=="positive") %>%
	arrange(cset_id) %>%
	group_by(cset_id) %>%
  count()
	
negative_controls_summary <- all_ris_no_filter %>%
	filter(cset_type=="negative") %>%
	arrange(cset_id) %>%
	group_by(cset_id) %>%
  count()



```

This report is a summary of the control data that has been processed so far. This step is meant to be executed only once, so the control sets are ready to use anytime the `NetworkEval` progam is ran.

# Summary of control sets

This is a summary of the control set files manually generated and kept in the [Google Drive](https://drive.google.com/drive/folders/1CaY_vu-2nmCQWGl0ugeMWp_qf0mR4tHx?usp=sharing). 

The controls sets were originally made of 4 columns: tf_bnum, tf_symbol, gene_bnum, gene_symbol. I checked their consistency using the last gene file generated by Hely.

Issues were found in sets `negative_1_1` and `positive_2_1`. Mainly it's a matter of **missing synonyms**. The B numbers concerned are the following:

* positive_2_1: b3767, b3768
* negative_1_1: b0624, b0703, b2245, b2246, b2575, b3504, b4104, b4339, b4658, b4659, b4661, b4693, b4695, b4600, b4694, U00096_orf00828

Two solutions:

* add the missing synonyms to the "master" file
* re-generate the sets

**Note:** The B numbers and symbols were checked using the gene file generated by Hely. However, we should consider **making a separate program**, available for any project, that could perform the following gene operations:

* Convert Bnumber to symbol
* Convert symbol to Bnumber (including synonyms)
* Check the validity of a given Bnumber list
* Get a list of Bnumbers that code exclusively for TFs
* Check if a given Bunmber is a TF-coding gene
* ...


```{r show-summary}

# kable(summary, digits=2, format.args = list(big.mark = ',')) %>% kable_styling(bootstrap_options = c("striped", "hover"))

colnames(summary) <- c("control_type", "strategy", "subset_number", "set_description", "person_in_charge", "cset_id", "filename", "status", "RIs", "issues")
datatable(summary %>% arrange(desc(control_type), strategy) %>% select(cset_id, set_description, person_in_charge, RIs, issues), rownames= FALSE, options = list(
  searching = FALSE,
  pageLength = 15,
  columnDefs = (list(list(width = '10px', targets = c(0, 2, 3, 4)), list(width = '150px', targets = c(1))))
))
# kable(positive_controls_summary, digits=2, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 20, bootstrap_options = c("striped", "hover"))
# 
# kable(negative_controls_summary, digits=2, format.args = list(big.mark = ',')) %>% kable_styling(full_width = F, font_size = 20, bootstrap_options = c("striped", "hover"))
```

# Summary of positive RIs

This table shows all of the RIs contained in the positive sets, and in how many of those they are found. This information could be used in order to **assess the level of confidence of each RI** individually. However, we should then consider other parameters:

* The method used to generate the control set, and in some cases, the thresholds
* The fact that some sets are intrisically redundant (`negative_2_1` and `negative_2_2`)
* Some interactions already have a confidence level attributed by RegulonDB, depending on a complicated recipe (types of experiments)

```{r show-summary-pos}
datatable(all_positive_ris, filter = 'bottom', options = list(pageLength = 15))
```

# Summary of negative RIs

This table shows all of the RIs contained in the negative sets, and in how many of those they are found. This information could be used in order to **assess the level of confidence of each RI** individually. However, we should then consider other parameters:

* The method used to generate the control set, and in some cases, the thresholds
* The fact that some sets are intrisically redundant (`negative_2_1` and `negative_2_2`)
* Some interactions already have a confidence level attributed by RegulonDB, depending on a complicated recipe (types of experiments)

```{r show-summary-neg}
datatable(all_negative_ris, filter = 'bottom', options = list(pageLength = 15))

```

# Ambiguous interactions

The following interactions were found in at least one positive set and one negative set. 

Should they be excluded without further investigation, or carefully revised depending on the level of confidence of the sets they'fe in?

```{r upset-plot}
datatable(ambivalent_ris, filter = 'bottom', options = list(pageLength = 15))
```

# Set intersections

The following upset plot shows the interactions between all control sets.

```{r show-upset}

list_cset_id <- c("positive_1_1", "positive_2_1", "negative_2_1", "negative_2_2", "negative_1_1")

list_sets_ri <- list()
for (cset in list_cset_id) {
	df <- all_ris_no_filter %>% filter(cset_id == cset) %>% mutate(ri=paste0(tf_bnum, "_", gene_bnum))
	list_sets_ri[[cset]] <- df$ri
}
# sets <- list_to_matrix(list_sets_ri)
# m1 <- make_comb_mat(list_sets_ri, mode = "intersect")


upset(fromList(list_sets_ri), nsets = 6, number.angles = 30, point.size = 3.5, line.size = 2, 
    mainbar.y.label = "Sets Intersections", sets.x.label = "Set IDs", 
    text.scale = c(1.3, 1.3, 1, 1, 2, 1.5), order.by='freq')


```


